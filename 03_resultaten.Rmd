# Methodologie

## Gebiedsbeschrijving

De getijstuw in Dendermonde bevindt zich op de Zeeschelde, net stroomafwaarts van de samenvloeiing met de Dender.
De stuw maakt deel uit van het getijdengebonden deel van de Schelde en ligt binnen een overstromingsgevoelige zone met een uitgesproken estuarien karakter.
Het omliggende landschap wordt gekenmerkt door brede riviervlaktes, slikken en schorren, en kent sterke wisselingen in waterstand als gevolg van de getijwerking vanuit de Noordzee.
De Zeeschelde is op deze locatie onderhevig aan een semidiurnaal getij, met gemiddeld twee hoogwaters en twee laagwaters per etmaal.
De getijstuw reguleert de getij-invloed stroomopwaarts en laat gecontroleerde doorstroming toe richting het binnenland.
De stuw fungeert als overgangsstructuur tussen het maritiem beïnvloede getijregime en het meer gestabiliseerde waterpeil in de bovenlopen van het riviersysteem.
Aan de bovenstroomse zijde van de stuw geldt een theoretisch streefpeil van **3,82 meter TAW**, dat als referentiepeil wordt gehanteerd voor het waterbeheer in deze zone.
Dit peil zorgt voor een gecontroleerde opstuwing van het water in de richting van de Dender bovenstrooms van Dendermonde.
Het handhaven van dit peil is essentieel voor de werking van de stuw en het algemene peilbeheer in het intergetijdengebied.
De bodemplaat van de stuw ligt op -1.95 meter TAW.

Het sluisstuwcomplex van Dendermonde bestaat uit een combinatie van een stuwconstructie, een schutsluis en bijhorende infrastructuur voor waterbeheersing.
Het ontwerp laat een gereguleerde uitwisseling toe tussen de getijdeninvloeden van de Zeeschelde en het bovenstrooms gelegen binnenwaterstelsel van de Dender.

Het complex is opgebouwd uit meerdere functionele zones.
Centraal bevinden zich de doorstroomopeningen van de stuw, geflankeerd door oeverconstructies en geleidewerken.
Deze stuwsecties laten gecontroleerde waterafvoer toe in functie van het getij en het bovenstroomse peilbeheer.
De schutsluis is parallel aan de stuw gelegen en dient voor de doorgang van de scheepvaart.
Ze verbindt het benedenstroomse getijdeel van de Schelde met het hoger gelegen niet-getijgebonden deel van de Dender.

De **doorsnede B–C** toont een typische dwarsdoorsnede door de stuw.
De stuw is uitgevoerd met een betonnen onderbouw en verticale stuwschuiven of segmenten, die hydraulisch bediend worden.
Boven de stuw bevindt zich een stalen bovendorpel waarop de bedieningselementen en brugstructuren rusten.
De waterlijn varieert afhankelijk van de getijstand en de regeling van de stuwsegmenten.
Aan de benedenstroomse zijde is een erosiebeschermingslaag aangebracht om bodemscour ten gevolge van valhoogte en stroming te vermijden.

In de **doorsnede D–E** wordt een langsdoorsnede getoond over een deel van het complex, waarbij zowel de bedieningsconstructie als het waterverloop over de stuw zichtbaar zijn.
Het verschil in waterpeil tussen boven- en benedenstroomse zijde is goed merkbaar, vooral bij laag tij.
De doorsnede illustreert eveneens de integratie van geleidewerken en walkanten, wat belangrijk is voor de geleiding van schepen en voor de hydraulische vormgeving van de instroomzones.

## Studieperiode

Door het ontbreken van data over de stroomopwaartse en stroomafwaartse peilen (op waterinfo ontbreekt de meeste data van 2023, zijn temporele resoluties inconsistent vanaf juni 2024 en werden de stationsdata mogelijk omgewisseld in 2025) is de studieperiode beperkt tot 1/1/2024 tot en met 1/4/2024

## Onderzoeksluik 1: Analyse en voorbereiding via terreinbezoeken, dataverwerking en overleg

Deze eerste fase richt zich op het verzamelen van relevante informatie en het opbouwen van inzicht in het functioneren en het beheer van de getijdestuw in Dendermonde.
Hierbij wordt zowel gebruik gemaakt van terreinobservaties als van historische data en overleg met betrokken beheerders en experten.

De belangrijkste activiteiten binnen deze deelopdracht zijn:

-   **Terreinbezoeken en overlegmomenten**
    -   Bezoek aan de getijdestuw op de Dijle te Mechelen, waar sinds 2010 een aangepaste ‘vismigratiestand’ gehanteerd wordt (cf. Stevens & Coeck, 2010).
    -   Bezoek aan de getijdestuw op de Dender te Dendermonde.
    -   Doel van deze bezoeken is het documenteren van de werking ter plaatse, het identificeren van technische en operationele kenmerken, en het leren uit praktijkervaringen (do’s en don’ts).
-   **Data-analyse en visualisatie**
    -   Analyse van beschikbare meetreeksen van debieten, op- en afwaartse waterstanden en klepstanden van de stuw in Dendermonde.
    -   Opmaak van grafieken en samenvattende figuren die de relatie tussen debiet, waterstand en klepstand inzichtelijk maken onder verschillende omstandigheden (tij, seizoen, stuwstand).
    -   Analyse van frequentie en duur van potentiële migratievensters.
-   **Overleg met experten en betrokken instanties**
    -   Organisatie van overlegmomenten met specialisten van het Waterbouwkundig Laboratorium (WL) en andere relevante actoren (bv. VMM, De Vlaamse Waterweg).
    -   Doel is het aftoetsen van inzichten, bespreken van knelpunten, en verkennen van technische randvoorwaarden voor aanpassing van het beheer.
-   **Opmaak van een voorstel voor aangepast stuwbeheer**
    -   Formulering van een beheerstrategie die vismigratie faciliteert, rekening houdend met ecologische, hydraulische en nautische randvoorwaarden.
    -   Indien relevant, gebeurt dit naar analogie met het beheer van de Dijlestuw in Mechelen.
    -   Het voorstel wordt besproken en verfijnd in samenwerking met het WL.

## Onderzoeksluik 2: Potentiële bijkomende metingen en schaalmodelstudie

Afhankelijk van de resultaten en aanbevelingen uit deelopdracht 1, kan het nodig blijken om bijkomende metingen uit te voeren of een schaalmodelstudie op te zetten.

Dit tweede onderzoeksluik wordt voorlopig **niet opgenomen in dit rapport**, aangezien de noodzaak en haalbaarheid hiervan eerst met het WL geëvalueerd worden.
Indien beslist wordt om deze stap uit te voeren, kan onderzoeksluik 2 bestaan uit:

-   **Hydraulische terreinmetingen**
    -   Uitvoering van meetcampagnes onder verschillende debietscondities, in samenwerking met het WL.
    -   Metingen van stromingsprofielen, snelheden, en waterstanden op en nabij de stuw.
-   **Schaalmodelonderzoek**
    -   Eventuele opbouw en inzet van een fysiek schaalmodel door het WL.
    -   Analyse van stromingsdynamiek en vispasseerbaarheid onder gecontroleerde omstandigheden.
    -   Gebruik van het schaalmodel om alternatieve stuwinstellingen en beheersstrategieën te testen.

De concrete invulling van dit onderzoeksluik is afhankelijk van de resultaten en aanbevelingen van onderzoeksluik 1, en zal pas worden vastgelegd na overleg met het WL.

```{r}
source("./code/not_functions/libraries.R")
source("./code/functions/estimate_parameters_with_solver_to_optimize_vo.R")
source("./code/functions/find_parameter_combinations_to_optimize_vo.R")
```

```{r}
clean_waterinfo<-function(dir){
  files<-list.files(path=dir,pattern = ".csv")
  for (i in 1:length(files)){
    path<-paste0(dir,files[i])
    file_name<-gsub(".csv","",files[i])
    temp<-read.csv(path,sep=';',skip=7)[,1:2]
    colnames(temp)<-c("date","value")
    temp$loc<-paste(str_split_1(file_name,"_")[1],str_split_1(file_name,"_")[2])
    temp$regio<-str_split_1(file_name,"_")[2]
    temp$var<-tolower(str_split_1(file_name,"_")[3])
    temp$value<-as.numeric(sub(",", ".", temp$value, fixed = TRUE))
    if (i==1){data=temp} else {data=rbind(data,temp)}
  }
  data$date=substr(gsub("T", " ", as.character(data$date)),1,19)
  data$date_brussels = as.POSIXct(data$date,format='%Y-%m-%d %H:%M:%S',tz="Europe/Brussels")
  data$date_utc = data$date_brussels; attr(data$date_utc, "tzone") <- "GMT"
  data=unique(data)
  return(data)
}
```

```{r}
waterinfo<-clean_waterinfo(dir="./data/extern/omgeving/")

waterinfo$regio=factor(waterinfo$regio, levels=c("Dender","Zeeschelde"))
waterinfo$var=factor(waterinfo$var, levels=c("waterpeil","afvoer"))
waterinfo$loc=factor(waterinfo$loc, levels=c("Dendermonde Dender","Dendermonde Opwaarts DVW Dender","Dendermonde Afwaarts DVW tij Zeeschelde","Dendermonde tij Zeeschelde"))
```

```{r tijdreeksenstudieperiode1, fig.height=12, fig.width=10, fig.cap="Overzicht van metingen van waterpeil (m), voor relevante meetstations doorheen de tijd van 25 tot 28 januari 2024. De stations staan geordend van stroomopwaarts naar stroomafwaarts. Noteer hoe getracht wordt om het stroomopwaarts peil niet onder de 3.82 m TAW te laten komen."}
ggplot(waterinfo %>% dplyr::filter(date_utc>as.POSIXct("2024-01-25 00:00") & date_utc<as.POSIXct("2024-01-29 00:00")), aes(x = date_utc, y = value)) + 
  geom_line() +
  xlab("Datum") + ylab("Waterpeil (meter TAW)") +
  facet_wrap(~ var*loc, ncol = 1, scales="free_y") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  scale_x_datetime(date_labels = "%d-%m %H:%M", date_breaks = "12 hours") + theme_bw()
```

```{r tijdreeksenstudieperiode2, fig.height=12, fig.width=10, fig.cap="Overzicht van metingen van waterpeil (m), voor relevante meetstations doorheen de tijd van 25 tot 28 januari 2024. De stations staan geordend van stroomopwaarts naar stroomafwaarts. Noteer hoe getracht wordt om het stroomopwaarts peil niet onder de 3.82 m TAW te laten komen."}
ggplot(waterinfo %>% dplyr::filter(date_utc>as.POSIXct("2024-01-01 00:00") & date_utc<as.POSIXct("2024-04-01 00:00")), aes(x = date_utc, y = value)) + 
  geom_line() +
  xlab("Datum") + ylab("Waterpeil (meter TAW)") +
  facet_wrap(~ var*loc, ncol = 1, scales="free_y") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  scale_x_datetime(date_labels = "%d-%m %H:%M", date_breaks = "1 month") + theme_bw()
```

```{r message=FALSE, warning=FALSE}
dir='./data/extern/logboeken/verwerkt_in_excel/2024 Historiek/'
files<-list.files(path=dir)
for (i in 1:length(files)){
  path<-paste0(dir,files[i])
  temp=read_excel(path, sheet = 'Waterbeheersing',skip=15)[,c(4,5,9,10,11)] %>%
    dplyr::filter(!if_all(everything(), is.na))
  if (i==1){s=temp} else {s=rbind(s,temp)}
}

colnames(s)=c("date","time","opwaartswaterpeil","neerwaartswaterpeil","stuw")
s$datetime <- make_datetime(
  year = year(s$date),
  month = month(s$date),
  day = day(s$date),
  hour = hour(s$time),
  min = minute(s$time),
  sec = second(s$time),
  tz = "Europe/Brussels"
)
attr(s$datetime, "tzone") <- "GMT"
s <- s %>% 
  dplyr::select(-date,-time) %>% 
  mutate(    opwaartswaterpeil = as.numeric(gsub(",", ".", opwaartswaterpeil, fixed = TRUE)),
    neerwaartswaterpeil = as.numeric(gsub(",", ".", neerwaartswaterpeil, fixed = TRUE))) %>%
  dplyr::filter(is.na(stuw)==FALSE) %>% 
  mutate(opwaartswaterpeil = opwaartswaterpeil + 1.95,
         neerwaartswaterpeil = neerwaartswaterpeil + 1.95)

t <- s %>%
  mutate(
    hefactie = ifelse((grepl("[A-Za-z]", stuw)), TRUE, FALSE),
    sluice_height   = ifelse(!grepl("[a-zA-Z]", stuw), as.numeric(stuw), NA)/100 + 1.95,
    sluice_opening = ifelse(grepl("[a-zA-Z]", stuw), as.numeric(gsub("[^0-9]", "", stuw))/100, NA),
    sluice_height   = zoo::na.locf(sluice_height, na.rm = FALSE),
    sluice_opening = ifelse(is.na(sluice_opening), 0, sluice_opening), 
    sluice_height = sluice_height + sluice_opening,
    #sluice_opening = zoo::na.locf(sluice_opening, na.rm = FALSE),
    #sluice_height   = ifelse(hefactie == TRUE & sluice_height < sluice_opening + 4.65, sluice_opening + 4.65, sluice_height), 
    #sluice_opening   = ifelse(hefactie == FALSE & sluice_height < sluice_opening + 4.65, 0, sluice_opening),
    datetime = round_date(datetime, unit="5 mins")
  ) %>% 
  select(-stuw) %>%
  complete(datetime = seq(min(datetime), max(datetime), by = "5 min")) %>%
  fill(everything(), .direction = "down")
```

```{r}
data <- waterinfo %>% 
  dplyr::filter(date_utc>as.POSIXct("2024-01-01 00:00") & date_utc<as.POSIXct("2024-05-01 00:00") & var=="waterpeil" & loc %in% c("Dendermonde Opwaarts DVW Dender","Dendermonde Afwaarts DVW tij Zeeschelde")) %>% 
  dplyr::select(date_utc,var,loc,regio,value) %>% 
  mutate(var=paste(var,loc,regio,sep="_")) %>%
  dplyr::select(-loc,-regio) %>% 
  distinct(date_utc, var, .keep_all = TRUE) %>% 
  pivot_wider(names_from = var, values_from = value) %>%
  rename("h_downstream" = "waterpeil_Dendermonde Afwaarts DVW tij Zeeschelde_Zeeschelde",
         "h_upstream" = "waterpeil_Dendermonde Opwaarts DVW Dender_Dender") %>% 
  dplyr::select(date_utc, h_downstream, h_upstream) %>% 
  mutate(h_downstream=h_downstream+1.95,
         h_upstream=h_upstream+1.95) %>%
  left_join(t %>% select(datetime,sluice_height,sluice_opening),by= c("date_utc" = "datetime")) %>%
  drop_na() %>%
  mutate(
    bereikbaar = case_when(
      h_upstream < sluice_height & sluice_opening == 0 ~ "no",
      TRUE ~ "yes"
    ),
    bereikbaar_stroomafwaarts_over_stuw = case_when(
      h_upstream < sluice_height ~ "no",
      TRUE ~ "yes"
    ),
    bereikbaar_stroomopwaarts_over_stuw = case_when(
      h_downstream < sluice_height ~ "no",
      TRUE ~ "yes"
    ),
    bereikbaar_onder_stuw = case_when(
      sluice_opening == 0 ~ "no",
      TRUE ~ "yes"
    )
  )
```

In de volgende secties wordt beschreven hoe de berekeningen gebeuren.
Het spuidebiet (en de geassocieerde stroomsnelheid) van een getijdestuw op basis van metingen om de 5 minuten van het waterpeil boven- en benedenstrooms wordt berekend.
Debietsmetingen van de Dender ter hoogte van Dendermonde stroomopwaarts van de getijdestuw zijn voorhanden maar om een inschatting te kunnen maken van het debiet dat over de stuw gaat en het debiet dat onder de stuw gaat zijn berekeningen op basis van de stroomopwaartse en stroomafwaartse waterpeilen en stuwstanden nodig.
Wanneer er sprake is van vrije stroming waarbij de stuw volledig is opgetrokken of volledig onder water staat waardoor er geen hoogteverschil is tussen het stroomopwaarts en stroomafwaarts waterpeil kan het debiet niet berekend worden.
In die gevallen wordt het gemeten totaal debiet gebruikt omdat er dan geen onderscheid gemaakt moet worden tussen debiet dat over of onder de stuw gaat.

\
Er wordt in de berekeningen volgende zaken beschouwd:

1.  **Overstroming** (wanneer water over de stuw stroomt)
2.  **Onderstrooming** (wanneer water onder de stuw stroomt)
3.  **Villemonte-correctie** (voor het corrigeren van ondergedompelde stromingscondities)
4.  **Vrije stroming** (wanneer water "ongehinderd" kan stromen)

## Overzicht van de berekeningen

### Stroming over de stuw

$$
Q_o = C_e \cdot \frac{2}{3} \cdot b \cdot \sqrt{2g} \cdot h_o^{3/2}
$$ **Waar:** - $Q_o$ = Discharge over the weir/ Debiet over de stuw (m³/s) - $C_e$ = Discharge coefficient/ Debietscoefficiënt (dimensionless/ dimensieloos) - $b$ = Width of the weir/ Breedte van de stuw (m) - $g$ = Gravitational acceleration/ Zwaartekrachtversnelling (9.81 m/s²) - $h_o$ = Head over the weir crest/ Waterhoogte boven de stuwkruin (m)

### Stroming onder de stuw

$$
Q_u = C_d \cdot b \cdot h_u \cdot \sqrt{2g (h_{up} - h_{down})}
$$ **Waar:** - $Q_u$ = Discharge under the weir/ Debiet onder de stuw (m³/s) - $C_d$ = Discharge coefficient for underflow/ Debietscoefficiënt voor onderstroom (dimensionless/ dimensieloos) - $h_u$ = Height of weir opening/ Hoogte stuw opening (m) - $h_{up}$ = Upstream water level/ Stroomopwaarts waterpeil (m) - $h_{down}$ = Downstream water level/ Stroomafwaarts waterpeil (m)

### Villemonte Correctie

$$
Q_{corrected} = (Q_o + Q_u) \cdot \left[1 - \left(\frac{h_o}{h_{o2}}\right)^{3/2} \right]^{0.385}
$$ **Where:** - $Q_{corrected}$ = Adjusted discharge considering submergence/ Gecorrigeerde debiet submersie in beschouwing nemend(m³/s) - $h_{o2}$ = Reference head/ referentiehoogte (m)

### Vrije stroming

$$
Q_o = Q_{total} \cdot \left(\frac{h_o}{h_o + h_u}\right)
$$ **Waar:** - $Q_o$ = Discharge over the weir/ Debiet over de stuw (m³/s) - $Q_{total}$ = Total discharge/ Totaal debiet (m³/s) - $h_o$ = Head over the weir crest/ Waterhoogte boven de stuwkruin (m) - $h_u$ = Height of sluice opening/ Hoogte van de stuwopening (m)

$$
Q_u = Q_{total} \cdot \left(\frac{h_u}{h_o + h_u}\right)
$$ **Waar:** - $Q_u$ = Discharge under the weir/ Debiet onder de stuw (m³/s) - $Q_{total}$ = Total discharge/ Totaal debiet (m³/s) - $h_o$ = Head over the weir crest/ Waterhoogte boven de stuwkruin (m) - $h_u$ = Height of sluice opening/ Hoogte van de stuwopening (m)

### Stroomsnelheid

$$
V = \frac{Q}{A}
$$ **Waar:** - $V$ = Water velocity/ Waterstroomsnelheid (m/s) - $Q$ = Discharge/ Debiet (m³/s) - $A$ = Flow area/ Stromingsoppervlakte (m²) (Afhankelijk van of de stroming onder of over de stuw gaat)

Samengevat is de stroomsnelheid onder de stuw afhankelijk van het hoogteverschil tussen stroomopwaarts en stroomafwaarts peil, terwijl de stroomsnelheid over de stuw wordt bepaald door de waterhoogte boven de stuwkruin.

# Resultaten

```{r}
# Load hourly water level data (replace 'data.csv' with actual file)
data <- data

# Assume columns: 'date_utc', 'h_upstream', 'h_downstream', 'sluice_opening'
# head(data)
```

```{r}
# Define Discharge Function
compute_discharge <- function(h_up, h_down, h_si, h_u, b, C_e = 1.7, C_d = 0.6, g = 9.81) {
  
  if (h_up < h_down) {
    flow="up"
  } else {
    flow="down"
  }
  
  if (flow=="down"){
    h_o <- h_up - h_si  # Effective head over weir
  
    # Weir Flow
    Q_o <- C_e * (2/3) * b * sqrt(2 * g) * (h_o^(3/2))
    
    # Sluice Flow (if gate is open)
    Q_u <- ifelse(h_u > 0, C_d * b * h_u * sqrt(2 * g * (h_up - h_down)), 0)
    
    # Apply Villemonte Correction if submerged
    if (h_down >= h_o) {
      Q_o <- Q_o * (1 - (h_o / h_down)^(3/2))^0.385
    } 
  }
  
  if (flow=="up"){
    h_o <- h_down - h_si  # Effective head over weir
  
    # Weir Flow
    Q_o <- C_e * (2/3) * b * sqrt(2 * g) * (h_o^(3/2))
    
    # Sluice Flow (if gate is open)
    Q_u <- ifelse(h_u > 0, C_d * b * h_u * sqrt(2 * g * (h_down - h_up)), 0)
    
    # Apply Villemonte Correction if submerged
    if (h_up >= h_o) {
      Q_o <- Q_o * (1 - (h_o / h_up)^(3/2))^0.385
    } 
    
    Q_o = Q_o * -1
    Q_u = Q_u * -1
  }
  
  if (is.na(Q_o) == TRUE){Q_o = 0}
  
  # Compute Velocity (using total area depending on flow type)
  A_o <- b * h_o  # Cross-section for overflow
  A_u <- b * h_u  # Cross-section for underflow
  V_o <- ifelse(A_o > 0, Q_o / A_o, 0)
  V_u <- ifelse(A_u > 0, Q_u / A_u, 0)
  
  return(list(h_o = h_o, Q_o = Q_o, Q_u = Q_u, V_o = V_o, V_u = V_u))
}
```

```{r}
# Calculate Discharge for All Data
discharge_results <- mapply(compute_discharge, 
                            h_up = data$h_upstream, 
                            h_down = data$h_downstream, 
                            h_si = data$sluice_height,
                            h_u = data$sluice_opening, 
                            b = 17, 
                            SIMPLIFY = FALSE)

data <- data %>% 
  mutate(h_o = sapply(discharge_results, function(x) x$h_o),
         Q_o = sapply(discharge_results, function(x) x$Q_o),
         Q_u = sapply(discharge_results, function(x) x$Q_u),
         Q_total = rowSums(across(c(Q_o, Q_u)), na.rm = TRUE),
         V_o = sapply(discharge_results, function(x) x$V_o),
         V_u = sapply(discharge_results, function(x) x$V_u),
         )

#head(data)
```

```{r}
data <- data %>%
  mutate(
    freeflow_via_weir = case_when(
      h_downstream > sluice_height & h_upstream > sluice_height ~ "yes",
      TRUE ~ "no"
    ),
    freeflow_via_sluice = case_when(
      h_downstream < sluice_opening & h_upstream < sluice_opening ~ "yes",
      TRUE ~ "no"
    )
  )

# left_join data and waterinfo (loc==afvoer only) based on date_utc
data <- data %>%
  left_join(waterinfo %>% dplyr::filter(var == "afvoer") %>% dplyr::select(date_utc, value), by = "date_utc") %>%
  rename(Q_total_waterinfo = value)

# if freeflow_via_weir=="yes" then Q_o = Q_total_waterinfo and Q_total = Q_total_waterinfo and q_u = 0, if freeflow_via_sluice=="yes" then Q_u = Q_total_waterinfo and Q_total = Q_total_waterinfo and q_o = 0
# data <- data %>%
#   mutate(
#     Q_o = ifelse(freeflow_via_weir == "yes", Q_total_waterinfo, Q_o),
#     Q_u = ifelse(freeflow_via_sluice == "yes", Q_total_waterinfo, Q_u),
#     Q_total = ifelse(freeflow_via_weir == "yes" | freeflow_via_sluice == "yes", Q_total_waterinfo, Q_total),
#     V_o = ifelse(freeflow_via_weir == "yes", Q_total_waterinfo / (17 * h_o), V_o),
#     V_u = ifelse(freeflow_via_sluice == "yes", Q_total_waterinfo / (17 * sluice_opening), V_u)
#   )

data <- data %>%
  mutate(
    h_o_temp = ifelse(h_o<0, 0, h_o),
    sluice_opening_temp = ifelse(sluice_opening<0, 0, sluice_opening),
    Q_o = ifelse(freeflow_via_weir == "yes" | freeflow_via_sluice == "yes", Q_total_waterinfo*(h_o_temp/(h_o_temp+sluice_opening_temp)), Q_o),
    Q_u = ifelse(freeflow_via_sluice == "yes", Q_total_waterinfo*(sluice_opening_temp/(h_o_temp+sluice_opening_temp)), Q_u),
    Q_total = ifelse(freeflow_via_weir == "yes" | freeflow_via_sluice == "yes", Q_total_waterinfo, Q_total),
    V_o = ifelse(freeflow_via_weir == "yes" | freeflow_via_sluice == "yes", Q_o / (17 * h_o), V_o),
    V_u = ifelse(freeflow_via_sluice == "yes" | freeflow_via_sluice == "yes", Q_u / (17 * sluice_opening), V_u)
  )
```

## Tijdreeksen

Stroomafwaarts van de getijsluis wordt een uitgesproken getijderegime waargenomen (Fig. \@ref(fig:tijdsreeksberekeningen)) met laag- en hoogwaterstanden tussen de 2.86 m (0.91 m TAW) en 8.46 m (6.41 m TAW).
Stroomopwaarts is er een streefpeil van 5.77 m (3.82 m TAW).
In perioden van grote afvoer wanneer de stuw langs onder voor een langere tijd openstaat dan zien we het effect van laag getij op het stroomopwaarts peil dat lager wordt dan het streefpeil tot 4.79 m (6.74 m TAW).
Wanneer het water onder de stuw gaat, observeren we eveneens een duidelijke daling van de waterhoogte boven de stuwkruin.
Water zal zelden gelijktijdig onder als boven de stuw gaan.

```{r tijdsreeksberekeningen, fig.width=12, fig.height=20, out.width='100%', out.height='90%', fig.align='center', fig.cap="Tijdreeksen van waterhoogte en debiet. $h_{downstream}$ en $h_{upstream}$ zijn de waterhoogtes stroomafwaarts en stroomopwaarts van de stuw, $h_u$ is de hoogte van de stuwopening, $h_o$ is de waterhoogte boven de stuwkruin, $Q_o$ is het debiet over de stuw, $Q_u$ is het debiet onder de stuw."}
data %>%
  dplyr::select(-h_o_temp) %>%
  pivot_longer(
    cols = c(matches("^(h_|Q_)(?!total_waterinfo$)", perl = TRUE), sluice_opening),
    names_to = "variable",
    values_to = "value"
  ) %>%
  mutate(
    variable = if_else(variable == "sluice_opening", "h_u", variable),
    # Reorder the variable column as a factor
    variable = factor(variable, levels = c("h_downstream", "h_upstream", "h_o", "h_u", "Q_total", "Q_o", "Q_u"))
  ) %>%
  ggplot(aes(x = date_utc, y = value)) +
  geom_line() +
  facet_wrap(~ variable, scales = "free_y", ncol = 1,
             labeller = as_labeller(c(
               h_downstream = "Stroomafwaarts waterpeil in meter (h_downstream)",
               h_upstream = "Stroomopwaarts waterpeil in meter (h_upstream)",
               h_o = "Waterhoogte boven stuwkruin in meter (h_o)",
               h_u = "Opening onder de stuw in meter (h_u)",
               Q_total = "Totaal debiet in m³/s (Q_total)",
               Q_o = "Debiet over de stuw in m³/s (Q_o)",
               Q_u = "Debiet onder de stuw in m³/s (Q_u)"
             ))
  ) +
  labs(
    x = "Datum", y = "Waarde"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

```{r debiettijdreeks, fig.width=12, fig.height=8, out.width='100%', fig.align='center', fig.cap="Tijdreeksen van debiet. $Q_o$ is het debiet over de stuw, $Q_u$ is het debiet onder de stuw."}
ggplot(data, aes(x = date_utc)) +
  geom_line(aes(y = Q_o, color = "Debiet over stuw (Q_o)")) +
  geom_line(aes(y = Q_u, color = "Debiet onder stuw (Q_u)")) +
  labs(y = "Debiet (m³/s)", x = "Tijd", color = NULL) +
  scale_color_manual(values = c("blue", "red")) + 
  theme_minimal(base_size = 18) +
  theme(
    legend.position = "bottom"  # move legend below
  )
  
```

```{r stroomsnelheidtijdreeks, fig.width=12, fig.height=8, out.width='100%', fig.align='center', fig.cap="Tijdreeksen van waterstroomsnelheid. $V_o$ is de stroomsnelheid over de stuw, $V_u$ is de stroomsnelheid onder de stuw."}
ggplot(data %>% dplyr::filter(V_o<8), aes(x = date_utc)) +
  geom_line(aes(y = V_o, color = "Stroomsnelheid over stuw (V_o)")) +
  geom_line(aes(y = V_u, color = "Stroomsnelheid onder stuw (V_u)")) +
  labs(y = "Stroomsnelheid (m/s)", x = "Tijd", color = NULL) +
  scale_color_manual(values = c("green", "purple")) + 
  theme_minimal(base_size = 17) +
  theme(
    legend.position = "bottom"  # move legend below
  )
```

```{r}
data <- data %>%
  mutate(
    passeerbaar_stroomopwaarts_over_stuw = case_when(
      bereikbaar_stroomopwaarts_over_stuw == "yes" & V_o < 1 ~ "yes",
      TRUE ~ "no"
    ),
    passeerbaar_stroomopwaarts_onder_stuw = case_when(
      bereikbaar_onder_stuw == "yes" & V_u < 1 ~ "yes",
      TRUE ~ "no"
    ),
    passeerbaar_stroomopwaarts = case_when(
      passeerbaar_stroomopwaarts_over_stuw == "yes" | passeerbaar_stroomopwaarts_onder_stuw == "yes" ~ "yes",
      TRUE ~ "no"
    ),
    passeerbaar_stroomafwaarts_over_stuw = case_when(
      bereikbaar_stroomafwaarts_over_stuw == "yes" & V_o > -1 ~ "yes",
      TRUE ~ "no"
    ),
    passeerbaar_stroomafwaarts_onder_stuw = case_when(
      bereikbaar_onder_stuw == "yes" & V_u > -1 ~ "yes",
      TRUE ~ "no"
    ),
    passeerbaar_stroomafwaarts = case_when(
      passeerbaar_stroomafwaarts_over_stuw == "yes" | passeerbaar_stroomafwaarts_onder_stuw == "yes" ~ "yes",
      TRUE ~ "no"
    )
  )
```

```{r}
write.csv(data, file = "./data/intern/data.csv")
```

```{r}
data <- data %>%
  mutate(date = as_date(date_utc),
         month = month(date_utc, label = TRUE),
         year = year(date_utc))
```

Het getij t.h.v. Dendermonde is eb-gedreven aangezien eb 1.52 keer zo lang duurt als vloed (Fig. \@ref(fig:getijtijdreeks)).
Aangezien hetzelfde volume dat binnenstroomt weer moet uitstromen is het getij-gebonden debiet 1.52 keer zo hoog bij vloed dan bij eb.
Met andere woorden, gemiddeld genomen zal een opening van de stuw van een bepaalde duur bij vloed meer getij-gebonden water binnenlaten dan een opening van dezelfde duur bij eb.

```{r getijtijdreeks, fig.width=12, fig.height=8, out.width='100%', fig.align='center', fig.cap="Tijdreeksen van stroomafwaarts waterpeil met indicatie van eb en vloed."}
source("./code/functions/add_tidal_cycle_id_manual.R")

# --- 1. Process the data to add tidal IDs and phases ---
data <- add_tidal_cycle_id_manual(data, smoothing_hours = 0.5)

# --- 2. Filter for the first three tidal cycles ---
# The number of cycles may vary based on your data and smoothing,
# so this is a robust way to select the first few.
max_cycle_id <- min(5, max(data$tidal_cycle_id[-c(1:100)], na.rm = TRUE))
plot_data <- data[-c(1:100),] %>%
  dplyr::filter(tidal_cycle_id <= max_cycle_id) %>%
  dplyr::filter(is.na(tide_direction)==FALSE)

# --- 3. Create the plot with colored phases and vertical lines for cycles ---
ggplot(plot_data, aes(x = date_utc, y = h_downstream)) +
  # Use geom_rect to highlight the tidal phases
  geom_rect(
    aes(xmin = date_utc, xmax = lead(date_utc), ymin = -Inf, ymax = Inf, fill = tide_direction),
    alpha = 0.3
  ) +
  # Add the main water level line
  geom_line(color = "blue", size = 1) +
  # Add vertical lines to mark the start of each tidal cycle
  # geom_vline(
  #   data = plot_data %>% dplyr::filter(tidal_cycle_id != dplyr::lag(tidal_cycle_id, default = first(tidal_cycle_id))),
  #   aes(xintercept = date_utc),
  #   linetype = "dashed",
  #   color = "red",
  #   size = 0.5
  # ) +
  labs(
    title = paste("Stroomafwaarts waterpeil voor", max_cycle_id, "getijcycli"),
    x = "Datum",
    y = "Stroomafwaarts waterpeil (m)",
    fill = "Getij"
  ) +
  theme_minimal()

```

```{r eval=FALSE}
as.data.frame(table(data$tide_direction, data$date)) %>%
  pivot_wider(
    names_from = Var1, 
    values_from = Freq) %>%
  mutate(ratio=Ebb/Flood) %>%
  summarize(median=median(ratio))
```

Onder de meeste omstandigheden blijft de getijdestuw op de bodem en wordt het waterpeil enkel geregeld door de bovenste plaat waarbij water enkel over de stuw gaat en niet eronder (62.0 % van de tijd) (Tabel \@ref(tab:stats)).
In periodes van verhoogd debiet wordt de onderste stuwplaat gebruikt waardoor water voornamelijk onder de stuw gaat (26.8 % van de tijd).
16.1 % van de tijd gaat er geen water over of onder de stuw en in 4.9 % van de tijd gaat het water zowel over als onder de stuw.
Water gaat dus voornamelijk ofwel boven de stuw of onder de stuw maar zelden gelijktijdig.

Om vispassage te evalueren werden twee zaken in beschouwing genomen: Contact tussen het stroomopwaarts en stroomafwaarts pand via water en stroomsnelheid.
Het contact tussen het stroomopwaarts en stroomafwaarts pand is enkel relevant voor vispassage over de stuw.
Het water kan daar immers traag genoeg stromen maar als de stuw hoger staat dan het stroomafwaarts peil dan is het stroomopwaarts pand alsnog niet bereikbaar.
Voor water dat onder de stuw gaat is dat geen probleem want watercontact is gegarandeerd van het moment dat de stuw open gaat langs onder.
Voor beide opties, boven en onder de stuw, is stroomsnelheid wel belangrijk.
Vispassage wordt mogelijk geacht wanneer de stroming waartegen vissen zich moeten verzetten minder dan 1 m/s is.
Als er watercontact is dan spreken we in dit rapport van bereikbaarheid.
Als er watercontact is en de stroomsnelheid is opzwembaar dan spreken we in dit rapport van passeerbaarheid.

Indien er water over de stuw gaat dan is in 41.2 % van de tijd, het stroomopwaarts pand bereikbaar (i.e. opzwembaar indien stroomsnelheid niet limiterend zou zijn) (Tabel \@ref(tab:stats) en Fig.
\@ref(fig:puntenoverber)).
Indien er water over de stuw gaat dan is in 11.3 % van de tijd, de getijstuw passeerbaar (i.e. opzwembaar waarbij stroomsnelheid limiterend is) (Tabel \@ref(tab:stats) en Fig.
\@ref(fig:puntenover)).
Indien er water onder de stuw gaat dan is in 30.9 % van de tijd, de getijstuw passeerbaar (i.e. opzwembaar waarbij stroomsnelheid limiterend is) (Tabel \@ref(tab:stats)en Fig.
\@ref(fig:puntenonder)).

```{r stats}
source("./code/functions/analyze_flow_and_passage.R")

# --- Execute the function on the sample data ---
results_df <- analyze_flow_and_passage(data)

# Print the results
results_df %>% kable(caption="Statistieken van debiet en potentieel voor vispassage")
```

```{r puntenoverber, fig.width=12, fig.height=8, out.width='100%', fig.align='center', fig.cap="Tijdreeksen van waterstroomsnelheid over de stuw met onderscheid tussen bereikbaar en niet-bereikbaar."}
ggplot(data %>% dplyr::filter(V_o < 8), aes(x = date_utc)) +
  geom_point(aes(y = V_o, color = bereikbaar_stroomopwaarts_over_stuw, group = bereikbaar_stroomopwaarts_over_stuw)) +
  labs(
    y = "Stroomsnelheid (m/s)", 
    x = "Tijd", 
    color = "Bereikbaar over stuw?"
  ) +
  scale_color_manual(values = c("no" = "red", "yes" = "green")) +  
  theme_minimal(base_size = 17) +
  theme(
    legend.position = "bottom"  # move legend below
  )
```

```{r puntenover, fig.width=12, fig.height=8, out.width='100%', fig.align='center', fig.cap="Tijdreeksen van waterstroomsnelheid over de stuw met onderscheid tussen passeerbaar en niet-passeerbaar."}
ggplot(data %>% dplyr::filter(V_o < 8), aes(x = date_utc)) +
  geom_point(aes(y = V_o, color = passeerbaar_stroomopwaarts_over_stuw, group = passeerbaar_stroomopwaarts_over_stuw)) +
  labs(
    y = "Stroomsnelheid (m/s)", 
    x = "Tijd", 
    color = "Passeerbaar over stuw?"
  ) +
  scale_color_manual(values = c("no" = "red", "yes" = "green")) +  
  theme_minimal(base_size = 17) +
  theme(
    legend.position = "bottom"  # move legend below
  )
```

```{r puntenonder, fig.width=12, fig.height=8, out.width='100%', fig.align='center', fig.cap="Tijdreeksen van waterstroomsnelheid onder de stuw met onderscheid tussen passeerbaar en niet-passeerbaar."}
ggplot(data %>% dplyr::filter(V_o < 8), aes(x = date_utc)) +
  geom_point(aes(y = V_u, color = passeerbaar_stroomopwaarts_onder_stuw, group = passeerbaar_stroomopwaarts_onder_stuw)) +
  labs(
    y = "Stroomsnelheid (m/s)", 
    x = "Tijd", 
    color = "Passeerbaar onder stuw?"
  ) +
  scale_color_manual(values = c("no" = "red", "yes" = "green")) +  
  theme_minimal(base_size = 17) +
  theme(
    legend.position = "bottom"  # move legend below
  )
```

```{r eval=FALSE}
data %>%
  # Filter out NA rows from smoothing and slack periods
  dplyr::filter(!is.na(tidal_cycle_id), !is.na(tide_direction)) %>%
  # --- Key Change: Filter out the first and last tidal cycle ID ---
  dplyr::filter(tidal_cycle_id != min(tidal_cycle_id, na.rm = TRUE) &
         tidal_cycle_id != max(tidal_cycle_id, na.rm = TRUE)) %>%
  group_by(tidal_cycle_id, tide_direction) %>%
  summarise(
    total_time_in_phase = n(),
    flow_over = sum(Q_o > 0, na.rm = TRUE),
    flow_under = sum(Q_u > 0, na.rm = TRUE),
    no_flow = sum(Q_o <= 0 & Q_u <= 0, na.rm = TRUE),
    both_flow = sum((Q_o > 0 & Q_u > 0), na.rm = TRUE),
    .groups = "drop"
  ) %>%
  # Calculate percentages for each phase within each cycle
  mutate(
    pct_flow_over = flow_over / total_time_in_phase * 100,
    pct_flow_under = flow_under / total_time_in_phase * 100,
    pct_no_flow = no_flow / total_time_in_phase * 100,
    pct_both_flow = both_flow / total_time_in_phase * 100
  ) %>%
  pivot_longer(
    cols = starts_with("pct_"),
    names_to = "metric_type",
    values_to = "percentage"
  ) %>%
  group_by(tide_direction, metric_type) %>%
  summarise(
    mean = round(mean(percentage, na.rm = TRUE), 1),
    median = round(median(percentage, na.rm = TRUE), 1),
    .groups = "drop"
  )
```

```{r}
data %>%
  # Filter out NA rows from smoothing and slack periods
  dplyr::filter(!is.na(tidal_cycle_id), !is.na(tide_direction)) %>%
  # --- Key Change: Filter out the first and last tidal cycle ID ---
  dplyr::filter(tidal_cycle_id != min(tidal_cycle_id, na.rm = TRUE) &
         tidal_cycle_id != max(tidal_cycle_id, na.rm = TRUE)) %>%
  group_by(tidal_cycle_id, tide_direction) %>%
  summarise(
    total_time_in_phase = n(),
    # New calculations for positive and negative discharge
    flow_over_pos = sum(Q_o > 0, na.rm = TRUE),
    flow_over_neg = sum(Q_o < 0, na.rm = TRUE),
    flow_under_pos = sum(Q_u > 0, na.rm = TRUE),
    flow_under_neg = sum(Q_u < 0, na.rm = TRUE),
    # Remaining metrics
    no_flow = sum(Q_o <= 0 & Q_u <= 0, na.rm = TRUE),
    both_flow = sum((Q_o > 0 & Q_u > 0), na.rm = TRUE),
    .groups = "drop"
  ) %>%
  # Calculate percentages for each phase within each cycle
  mutate(
    water_stroomt_over_stroomafwaarts = flow_over_pos / total_time_in_phase * 100,
    water_stroomt_over_stroomopwaarts = flow_over_neg / total_time_in_phase * 100,
    water_stroomt_onder_stroomafwaarts = flow_under_pos / total_time_in_phase * 100,
    water_stroomt_onder_stroomopwaarts = flow_under_neg / total_time_in_phase * 100,
    water_stroomt_niet = no_flow / total_time_in_phase * 100,
    water_stroomt_over_en_onder = both_flow / total_time_in_phase * 100
  )  %>%
# 3. Calculate the average and median percentages across all tidal cycles
  pivot_longer(
    cols = starts_with("water_"),
    names_to = "Beschrijving",
    values_to = "Percentage"
  ) %>%
  group_by(tide_direction, Beschrijving) %>%
  summarise(
    Gemiddelde = round(mean(Percentage, na.rm = TRUE), 1),
    Mediaan = round(median(Percentage, na.rm = TRUE), 1),
    .groups = "drop"
  ) %>% 
  kable()
```

```{r}
source("./code/functions/plot_tidal_cycle_analysis_combined.R")
# Call the function for a specific tidal cycle, for example, cycle 2.
```

Op 15 januari 2024 was het business as usual met de bovenste schuif die naar omhoog wordt geschoven als het stroomafwaarts waterpeil het stroomopwaarts streefpeil van 5.77 m bereikt.
Afhankelijk van de bovenafvoer neemt het stroomopwaarts peil dan meer of minder toe.
Net voor en net na de werking van de bovenste schuif is er dikwijls een kort venster voor vispassage doordat de stroomsnelheid niet te hoog is.

```{r tideplot20240115, fig.width=12, fig.height=8, out.width='100%', fig.align='center', fig.cap="Tijdreeksen van waterpeil en stuwwerking op 15 januari 2024."}
plot_tidal_cycle_analysis_combined(data, chosen_date = as.POSIXct("2024-01-15", tz = "UTC"))
```

Op 22 maart 2024 bleef de onderste schuif op de bodem staan waardoor er geen stroming was onder de schuif en passage enkel mogelijk kon zijn over de stuw (Fig. \@ref(fig:tideplot20240322)).
Voor de eerste getijcyclus van 22 maart stond de bovenkant van de bovenste schuif op 5.35 meteren water stroomde aanvankelijk over de stuw in stroomafwaartse richting.
Eens het stijgende stroomafwaartse waterpeil de hoogte van de stuw had bereikt stroomde het water in stroomopwaartse richting tot het tij keerde.
Vispassage was mogelijk tot 20 minuten na het keren van het tij, daarna werd de stroomsnelheid te hoog voor stroomopwaartse visbeweging.
Gedurende de tweede getijcyclus die dag werd de bovenste schuif wel geactiveerd bij vloed en meerbepaald net voor het stroomafwaarts peil het stroomopwaarts peil zou overschreden hebben.
De bovenste schuif schoof naar omhoog tot boven het hoogste stroomafwaarts waterpeil van die dag waardoor er gedurende meer dan zes uur geen water over of onder de stuw kon en er dus ook geen visbeweging mogelijk was.
Ongeveer twee uur na hoogwater zakte de bovenste schuif opnieuw waardoor het stroomopwaarts peil ook begon te dalen.
Stroomopwaartse migratie over de stuw was dan voor enkele minuten mogelijk.
De stroomsnelheid werd echter snel te hoog om nog vispassage mogelijk te maken.

```{r tideplot20240322, fig.width=12, fig.height=8, out.width='100%', fig.align='center', fig.cap="Tijdreeksen van waterpeil en stuwwerking op 22 maart 2024."}
plot_tidal_cycle_analysis_combined(data, chosen_date = as.POSIXct("2024-03-22", tz = "UTC"))
```

Op 5 januari stond de onderste schuif constant open wat leidde tot een aanzienlijke periode waarin vispassage onder de stuw mogelijk was (Fig. \@ref(fig:tideplot20240105)).
Water kon ongehinderd stromen tot ongeveer 16h (wat ook te zien is aan het minimale verschil tussen stroomopwaarts en stroomafwaarts peil in die periode).
Na 16h werd de onderste schuif naar beneden geschoven waardoor het stroomopwaartse peil meer toenam dan eerder op de dag en waardoor de stroomsnelheid onder de stuw aanzienlijk toenam.
Na de kentering van het getij zorgde het vloedregime echter weer voor een gunstig regime voor stroomopwaartse migratie.

```{r tideplot20240105, fig.width=12, fig.height=8, out.width='100%', fig.align='center', fig.cap="Tijdreeksen van waterpeil en stuwwerking op 5 januari 2024."}
plot_tidal_cycle_analysis_combined(data, chosen_date = as.POSIXct("2024-01-05", tz = "UTC"))
```

Op 8 januari werd de onderste schuif opnieuw geopend maar in tegenstelling tot 5 januari stond de schuif niet heel de dag open en was de opening veel kleiner (Fig. \@ref(fig:tideplot20240108)).
Daardoor bleef het stroomafwaarts peil altijd lager dan de bovenkant van de stuw en was er dus geen sprake van vrije stroming.
De momenten dat de stuw vispasseerbaar waren, waren dan ook zeer beperkt.
Enkel rond de kentering wanneer wat water naar binnen kon stromen en het verschil tussen stroomopwaarts en stroomafwaarts peil minder dan 15 cm was, was vispassage mogelijk.

```{r tideplot20240108, fig.width=12, fig.height=8, out.width='100%', fig.align='center', fig.cap="Tijdreeksen van waterpeil en stuwwerking op 8 januari 2024."}
plot_tidal_cycle_analysis_combined(data, chosen_date = as.POSIXct("2024-01-08", tz = "UTC"))
```

## Tijdsaandeel bereikbaarheid en passeerbaarheid

```{r fig.width=12, fig.height=8, out.width='100%', fig.align='center'}
data %>%
  pivot_longer(
    cols = matches("^(bereikbaar|passeerbaar)_(via_)?(stroomopwaarts|stroomafwaarts)?"),
    names_to = "type",
    values_to = "status"
  ) %>%
  group_by(type) %>%
  summarise(
    totaal = n(),
    yes = sum(status == "yes", na.rm = TRUE),
    aandeel_yes = yes / totaal
  ) %>%
  mutate(
    group = if_else(str_detect(type, "^bereikbaar"), "Bereikbaar", "Passeerbaar"),
    type = fct_relevel(type,
                       sort(unique(type[str_detect(type, "^bereikbaar")])),
                       sort(unique(type[str_detect(type, "^passeerbaar")]))
    )
  ) %>%
  ggplot(aes(x = type, y = aandeel_yes, fill = group)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Bereikbaarheid en passeerbaarheid per route en richting",
    x = "Route × Richting", y = "Aandeel momenten",
    fill = "Categorie"
  ) +
  theme_minimal(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r fig.width=12, fig.height=20, out.width='100%', fig.align='center'}
data %>%
  mutate(month = floor_date(as_date(date_utc), "month")) %>%
  pivot_longer(
    cols = matches("^(bereikbaar|passeerbaar)_(via_)?(stroomopwaarts|stroomafwaarts)?"),
    names_to = "type",
    values_to = "status"
  ) %>%
  group_by(type, month) %>%
  summarise(
    totaal = n(),
    yes = sum(status == "yes", na.rm = TRUE),
    aandeel_yes = yes / totaal,
    .groups = "drop"
  ) %>%
  mutate(
  month_label = format(month, "%B %Y"),
  month_label = str_to_sentence(month_label),
  month_label = factor(month_label, levels = unique(month_label[order(month)])),
  group = if_else(str_detect(type, "^bereikbaar"), "Bereikbaar", "Passeerbaar"),
  type = fct_relevel(type,
                     sort(unique(type[str_detect(type, "^bereikbaar")])),
                     sort(unique(type[str_detect(type, "^passeerbaar")]))
    )
  ) %>%
  ggplot(aes(x = type, y = aandeel_yes, fill = group)) +
  geom_col() +
  facet_wrap(~ month_label, ncol = 1) +  # gebruik nieuwe maand-labels
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 1)) +
  labs(
    title = "Aandeel 'yes'-momenten per route × richting per maand",
    x = "Route × Richting", y = "Aandeel momenten",
    fill = "Categorie"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(face = "bold")
  )
```

```{r fig.width=12, fig.height=8, out.width='100%', fig.align='center'}
data %>%
  mutate(date = as.Date(date_utc)) %>%
  group_by(date) %>%
  summarise(
    doable_up = sum(passeerbaar_stroomopwaarts == "yes", na.rm = TRUE)/288,
    doable_down = sum(passeerbaar_stroomafwaarts == "yes", na.rm = TRUE)/288
  ) %>%
  pivot_longer(cols = c(doable_up, doable_down), names_to = "direction", values_to = "count") %>%
  mutate(direction = recode(direction,
                            "doable_up" = "Stroomopwaarts",
                            "doable_down" = "Stroomafwaarts")) %>%
  ggplot(aes(x = date, y = count, color = direction)) +
  geom_line() +
  labs(
    title = "Aandeel passeerbare momenten per dag per richting",
    x = "Datum", y = "Aandeel momenten (per dag)",
    color = "Richting"
  ) + 
  theme_minimal(base_size = 18)
```

```{r fig.width=12, fig.height=5, out.width='100%', fig.align='center'}
data %>%
  mutate(date = as.Date(date_utc)) %>%
  group_by(date) %>%
  summarise(
    up_onder_Stuw   = sum(passeerbaar_stroomopwaarts_onder_stuw == "yes", na.rm = TRUE)/288,
    up_over_Stuw    = sum(passeerbaar_stroomopwaarts_over_stuw == "yes", na.rm = TRUE)/288,
    down_onder_Stuw = sum(passeerbaar_stroomafwaarts_onder_stuw == "yes", na.rm = TRUE)/288,
    down_over_Stuw  = sum(passeerbaar_stroomafwaarts_over_stuw == "yes", na.rm = TRUE)/288
  ) %>%
  pivot_longer(
    cols = -date,
    names_to = "route_direction",
    values_to = "count"
  ) %>%
  separate(route_direction, into = c("direction", "route", "type"), sep = "_") %>%
  mutate(
    direction_label = recode(direction, "up" = "Stroomopwaarts", "down" = "Stroomafwaarts"),
    route_label = str_to_sentence(route),
    lijn = paste(route_label, "stuw"),
    groep = direction_label
  ) %>%
  ggplot(aes(x = date, y = count, color = lijn)) +
  geom_line(size = 1) +
  facet_wrap(~ groep, ncol = 2) +
  labs(
    title = "Aandeel passeerbare momenten per dag",
    x = "Datum", y = "Aandeel momenten",
    color = "Route"
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  theme_minimal(base_size = 16) +
  theme(
    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

```{r fig.width=12, fig.height=5, out.width='100%', fig.align='center'}
data %>%
  mutate(date = as.Date(date_utc)) %>%
  group_by(date) %>%
  summarise(
    up_onder_Stuw   = sum(passeerbaar_stroomopwaarts_onder_stuw == "yes", na.rm = TRUE)/288,
    up_over_Stuw    = sum(passeerbaar_stroomopwaarts_over_stuw == "yes", na.rm = TRUE)/288,
    down_onder_Stuw = sum(passeerbaar_stroomafwaarts_onder_stuw == "yes", na.rm = TRUE)/288,
    down_over_Stuw  = sum(passeerbaar_stroomafwaarts_over_stuw == "yes", na.rm = TRUE)/288
  ) %>%
  pivot_longer(
    cols = -date,
    names_to = "route_direction",
    values_to = "count"
  ) %>%
  separate(route_direction, into = c("direction", "route", "type"), sep = "_") %>%
  mutate(
    direction_label = recode(direction, "up" = "Stroomopwaarts", "down" = "Stroomafwaarts"),
    route_label = str_to_sentence(route),
    lijn = direction_label,
    groep = paste(route_label, "Stuw")
  ) %>%
  ggplot(aes(x = date, y = count, color = lijn)) +
  geom_line(size = 1) +
  facet_wrap(~ groep, ncol = 2) +
  labs(
    title = "Aandeel passeerbare momenten per dag",
    x = "Datum", y = "Aandeel momenten",
    color = "Richting"
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  theme_minimal(base_size = 16) +
  theme(
    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

## Range waterhoogte boven stuw voor stroomopwaartse passage over stuw

```{r eval=FALSE, warning=FALSE}
data_ho <- data %>% dplyr::filter(h_upstream!=h_downstream)

ho_results <- mapply(find_optimal_ranges, 
                            Q_total = data_ho$Q_total_waterinfo, 
                            V_o_threshold = 0.99,
                            h_up = data_ho$h_upstream,
                            h_down = data_ho$h_downstream, 
                            b = 17, 
                            SIMPLIFY = FALSE)

ho_results_df <- map_dfr(ho_results, as_tibble)

```

Hoe hoger het debiet, des te hoger dienen de opening onder de stuw en de waterhoogte boven de stuwkruin te zijn om vispassage over de stuw mogelijk te maken.
Bij een debiet van 10 m³ en een opening onder de stuw van 0.5 m is vispassage mogelijk vanaf een waterhoogte boven de stuwkruin van 1 m.
Bij een debiet van 90 m³ en een opening onder de stuw van 0.5 m is vispassage mogelijk vanaf een waterhoogte boven de stuwkruin van meer dan 5 m.

```{r rangebovenstuw, fig.width=12, fig.height=16, out.width='100%', fig.align='center'}
# Set the parameters for the plots
V_o_threshold <- 1
h_up <- 5.0
h_down <- 2.0
b <- 10.0
C_e <- 1.7
C_d <- 0.6
g <- 9.81

# Define the ranges for the plot variables
Q_total_values <- seq(from = 10, to = 90, by = 10)
h_o_values <- seq(from = 0.5, to = 3, by = 0.5)
h_u_range <- seq(from = 0, to = max(h_up, h_down), length.out = 100)

# Define the core velocity calculation function
get_vo <- function(h_o, h_u, Q_total) {
  if (h_o <= 0 || h_u < 0) return(NA_real_)
  
  flow = if (h_up < h_down) "up" else "down"
  
  if (flow == "down") {
    Q_u <- ifelse(h_u > 0, C_d * b * h_u * sqrt(2 * g * (h_up - h_down)), 0)
  } else {
    Q_u <- ifelse(h_u > 0, C_d * b * h_u * sqrt(2 * g * (h_down - h_up)), 0)
    Q_u <- Q_u * -1
  }
  
  Q_o_calc <- Q_total - Q_u
  
  if (Q_o_calc <= 0) return(NA_real_)
  
  V_o_calc <- Q_o_calc / (b * h_o)
  return(V_o_calc)
}

# Create a data frame for plotting
plot_data <- data.frame()

for (Q_total_val in Q_total_values) {
  for (h_o_val in h_o_values) {
    temp_df <- data.frame(
      h_u = h_u_range,
      V_o = sapply(h_u_range, get_vo, h_o = h_o_val, Q_total = Q_total_val),
      h_o = as.factor(h_o_val),
      Q_total = as.factor(Q_total_val)
    )
    plot_data <- rbind(plot_data, temp_df)
  }
}

# Plot the results using facets for Q_total
ggplot(plot_data, aes(x = h_u, y = V_o, color = h_o)) +
  geom_line(size = 1) +
  geom_hline(yintercept = V_o_threshold, linetype = "dashed", color = "black") +
  facet_wrap(~ Q_total, scales = "free_y") +
  labs(
    title = "Effect van opening benedenschuif op stroomsnelheid over de stuw voor verschillende debieten (m³/s)",
    x = "Opening onder de stuw (m)",
    y = "Stroomsnelheid over de stuw (m/s)",
    color = "Waterhoogte boven stuwkruin (m)"
  ) +
  xlim(0,2) +
  theme_minimal()
```

```{r eval=FALSE}
# Minimale combinaties van waterhoogte onder en boven stuw voor stroomopwaartse passage over stuw
Q_total_known <- data$Q_total_waterinfo[1]    # Total discharge (m3/s)
V_o_target_limit <- 0.99  # Target overflow velocity (m/s)
h_up_level <- data$h_upstream[1]     # Upstream water level (m)
h_down_level <- data$h_downstream[1]   # Downstream water level (m)
width_b <- 17       # Weir width (m)

# Find all possible combinations
solutions <- find_parameter_combinations_to_optimize_vo(
  Q_total = Q_total_known,
  V_o_target = V_o_target_limit,
  h_up = h_up_level,
  h_down = h_down_level,
  b = width_b
)

# Display the solutions
print(solutions)
```

## Range opening onder stuw voor stroomopwaartse passage onder stuw

Vispassage onder de stuw is onafhankelijk van de opening en wordt louter bepaald door het verschil tussen het stroomopwaarts en stroomafwaarts peil.
Stroomopwaartse vispassage onder de stuw is enkel mogelijk indien het verschil tussen stroomopwaarts en stroomafwaarts peil minder dan 14 cm bedraagt.
Bij vrije stroming is in 76.3 % van de gevallen de stuw passeerbaar langs onderen.

```{r rangeonderstuw, fig.width=12, fig.height=16, out.width='100%', fig.align='center'}
# Set the parameters for the plots
b <- 17
C_d <- 0.6
g <- 9.81

# Define a range for the head difference on the x-axis
# (h_up - h_down) can range from 0 up to a reasonable maximum
head_difference_range <- seq(from = 0, to = 5.0, length.out = 100)

# Define the core underflow velocity calculation function
get_vu <- function(head_diff) {
  if (head_diff <= 0) return(NA_real_)
  
  # The formula is simplified since h_up and h_down are not separate variables
  vu_calc <- C_d * sqrt(2 * g * head_diff)
  return(vu_calc)
}

# Create a data frame for plotting
plot_data <- data.frame(
  head_difference = head_difference_range,
  V_u = sapply(head_difference_range, get_vu)
)

# Plot the results
ggplot(plot_data, aes(x = head_difference, y = V_u)) +
  geom_line(size = 1, color = "blue") +
  labs(
    title = "Underflow Velocity vs. Head Difference",
    x = "Head Difference (h_up - h_down, in m)",
    y = "Underflow Velocity (V_u, in m/s)"
  ) +
  theme_minimal()

```

```{r eval=FALSE}
# Parameters from the immersive artifact
C_d <- 0.6
g <- 9.81

# Calculate the head difference for an underflow velocity of 1 m/s
head_diff <- 1 / (C_d^2 * 2 * g)

# Print the result
print(paste("The head difference for an underflow velocity of 1 m/s is:", round(head_diff, 4), "m"))
```
